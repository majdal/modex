<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

   
   <!-- libraries -->
   <!-- TODO: investigate using require.js or some other js dependency manager -->
   <script type="text/javascript" src="/assets/libs/jquery.min.js"></script>
   <script type="text/javascript" src="/assets/libs/json2.js"></script>

   <script type="text/javascript" src="/assets/libs/autobahn.js"></script>
   
   <script type="text/javascript" src="/assets/libs/ol.js"></script>
   <link rel="stylesheet" href="/assets/libs/ol.css" type="text/css">
   <script type="text/javascript" src="/assets/libs/d3.v3.js" charset="utf-8"></script>
   <script type="text/javascript" src="/assets/libs/crafty.js"></script>


   <!-- project code -->
   <link rel='stylesheet' href='css/style.css' type='text/css'/>
   
   <!-- crafty -->
   <script type="text/javascript" src="game.js"></script>
   <script type="text/javascript" src="controller.js"></script>
   
   <!-- d3 -->
   <script type="text/javascript" src="graph_component.js"></script>
   <script type="text/javascript" src="farm.js"></script>
   <script type="text/javascript" src="scenes/menu.js"></script>
   <script type="text/javascript" src="scenes/setup.js"></script>
   <script type="text/javascript" src="scenes/goals.js"></script>
   <script type="text/javascript" src="scenes/intro.js"></script>




   <title>ModEx all the things!!!</title>
   <style>

   </style>

</head>
<body>
    <h2>My Map</h2>
    <div id="map" class="map"></div>
    
    <!-- NB: temporarily disable the graph to make debugging the map easier -->
    <div id='graph' class='nothidden'></div>

    <style>
      .hidden { display: none } 
      .map {
        height: 600px;
        width: 100%;
      }
    </style>

  
  <script type="text/javascript">
global = this;
  $(function() {
 
 var connection = new autobahn.Connection({
   url: 'ws://127.0.0.1:8080/wamp',
   realm: 'realm1'});  //FEATURE REQUEST: error handling for autobahn plzkthx
 global.connection = connection;

connection.onopen = function (session) {
  console.log("opening session:");
  console.log(session)
  console.log(connection._websocket.readyState);

// hook the low-level handlers on the websocket to help debug what Autobahn thinks it is doing
// these must be done here because _websocket doesn't exist until connection.open()
connection._websocket.onerror = function(evt) {
  console.log("websocket error: " + evt.reason)
  console.log(evt)
}

connection._websocket.onclose = function(evt) { 
  console.log("websocket close: " + evt.reason)
  console.log(evt)
}


  //pubsub handlers can either take no args (JS just ignores extra args)
  function heartbeatHandler() {
    console.log("heartbeat");
  }

  //or args and kwargs (python-style, matching the args and kwargs passed from the python server side)
  function dataHandler(args,kwargs) {
    console.log("got data: " + "args = " + JSON.stringify(args) + ", kwargs = " + JSON.stringify(kwargs))
  }

  // or an additional "EventDetails" object which gives connection metadata
  function metaLooker(args, kwargs, evtDetails) {
    console.log("metadata details: " + JSON.stringify(evtDetails))
  }

  session.subscribe(heartbeatHandler, "heartbeat");
  session.subscribe(dataHandler, "data");
  session.subscribe(metaLooker, "heartbeat");
   
  // RPC is done with session.call(), which returns a Promise/A+ object -- something                                                   
  // with a .then() method that lets you attach callbacks
   
  // rpcFail is used as the error handler for RPC calls; it is optional.
  function rpcFail(error) {
    console.log("Call failed: " + JSON.stringify(error));
  }

  // RPC the parrot function with varous arguments
  function parrotHandler(r) {
    console.log("this is not a parrot nevermore:", JSON.stringify(r));
  }
  session.call('start').then(parrotHandler);

  global.session = session; //stash for debugging
}

connection.open() 
 
  })
  </script>


    <script type="text/javascript">
 //todo: move this to a jquery oninit() handler

var labels =  new ol.style.Text({
        color: '#bada55',
        text: 'hello', //grrrrr. this doesn't work.
        fontFamily: 'Calibri,sans-serif',
        fontSize: 14
      })

var styleArray = [new ol.style.Style({
  //fill: new ol.style.Fill({
  //  color: 'rgba(255, 255, 255, 0.6)'
  //}),
  //symbolizers: [labels],
  stroke: new ol.style.Stroke({
    color: '#319FD3',
    width: 1
  })
})];

var pointStyle = [new ol.style.Style({
    image: new ol.style.Circle({
      radius: 3,
      fill: new ol.style.Fill({color: 'red'}),
      stroke: new ol.style.Stroke({color: '#222222', width: 1.5})
    }),

  fill: new ol.style.Fill({
    color: 'rgba(255, 22, 255, 0.6)'
  }),
  stroke: new ol.style.Stroke({
    color: 'yellow',
    width: 2
  })


  })]

var styleArray2 = [new ol.style.Style({
  //image: new ol.style.Circle({
  fill: new ol.style.Fill({
    color: 'rgba(255, 22, 255, 0.6)'
  }),
  stroke: new ol.style.Stroke({
    color: 'yellow',
    width: 2
  })
  //})

})
];

styleArray2 = pointStyle;




var countries = new ol.layer.Vector({
  source: new ol.source.GeoJSON({
    url: 'assets/maps/countries.geojson'
  }),
  
  styleFunction: function(feature, resolution) {
    return styleArray;
  }
});

var meat = new ol.layer.Vector({
  source: new ol.source.GeoJSON({
    url: 'assets/maps/meatplants.geojson'
  }),
  styleFunction: function(feature, resolution) {
    return styleArray2;
  }

});


//          new ol.layer.Tile({     opacity: .5,        source: new ol.source.OSM()          }), //partially transparent

      var map = new ol.Map({
        renderer: ol.RendererHint.CANVAS, //the vector layer crashes without this. Go figure.
        target: 'map',
        layers: [
          new ol.layer.Tile({ source: new ol.source.MapQuest({layer: 'osm'}) }),
          countries,
          meat
        ],
        view: new ol.View2D({
          center: ol.proj.transform([-80.5, 43.45], 'EPSG:4326', 'EPSG:3857'), //these coordinates are not what you'll find on Wikipedia or in the World Fact Book. The Wikipedia coordinates, 43,28,0 N by 80,30,0W are A) in Degrees-Minutes-Seconds B) in WGS84 (so even once converted to decimal degrees they're slightly off)
          zoom: 11
        })
      });

    </script>

</body>
</html>
