<html>

<head>
 <title>Experimental WAMP.ws code</title>
 <script type="text/javascript" src="../../assets/libs/autobahn.js"></script>
 <!--<script type="text/javascript" src="frontend.js"></script>-->
 <script type="text/javascript">
  var global = this;
  window.onload = function() {  //demo code from https://github.com/tavendo/AutobahnJS
    // careful: using var makes a local that shadows the global autobahn (python scoping rules)
  console.log("loading");
  autobahn._debugpubsub = true;

var connection = new autobahn.Connection({
   url: 'ws://127.0.0.1:9000/',
   realm: 'realm1'});

connection.onopen = function (session) {
   console.log("opening session:");
   console.log(session)
   
   function heartbeatHandler(e) { 
     console.log("heartbeat");
   }

   function dataHandler(e) { 
     console.log("got data:");
     console.log(e);
   }

   session.subscribe(heartbeatHandler, "lovetriangle", {});
   session.subscribe(dataHandler, "haterhombus", {});
  
  console.log(connection._websocket.readyState);
  global.session = session; //stash for debugging
}



global.connection = connection; //stash for debugging

connection.open();
console.log(connection._websocket.readyState);

connection._websocket.onerror = function(evt) {
  console.log("websocket error: " + evt.reason)
  console.log(evt)
}

connection._websocket.onclose = function(evt) {
  console.log("websocket close: " + evt.reason)
  console.log(evt)
}

console.log(connection._websocket.readyState);
}

</script>



</head>
<body>

<h1>WAMP with AutobahnJS and AutobahnPython</h1>

Run server.py (found in the same folder), open up the web inspector to the JS console, and reload this page.

<h2>Known Bugs</h2>
The API versions are inconsistent amongst the varieties of Autobahn, so there's some issues to work through.
<ol>
<li>heartbeatHandler() is crashing and I don't know why; maybe because it's not getting an argument?</li>
<li>The data that is passed through to dataHandler() is only the first element in the list of args, though the server appears to be formatting it as if it knows what it's doing (e.g. 
 <code><pre>
2014-02-12 21:19:02-0500 [-] TX Frame to 127.0.0.1:60876 : fin = True, rsv = 0, opcode = 1, mask = -, length = 95, repeat_length = None, chopsize = None, sync = False, payload = [36,6491576786669246,6795983798931556,{},[69,23],{"c":"Hello","d":{"counter":9,"foo":[1,2,3]}}]
</pre></code></li>
</ol>

<h2>Complaints and Disentangling Thoughts</h2>

<p>I'm concerned that WAMP is wasteful. It seems ..sort of silly.
 It screams overengineered to me. It's entirely possible I'm just being picky.

<p> Do we ~need~ it? It seems simpler to run a separate WebSocket endpoint for each feed
  (we might have scaling issues with that)
 I suppose Autobahn transparently handles multiple subscribers to the same stream, and that ~is~ a difficult feature that we need
  </p>

<p>
 The flash of the website combined with how out of date it is is give me jiggies.
 They link to a bunch of implementations, making it look like it has wide support,
 but every implementation has only one contributor, less than 50 commits, or is explicitly alpha software.
 WAMP is hardly a protocol; it's Oberstet (aka Tavendo)'s baby. See: http://xkcd.com/927/</p>

<p>
 oh brother: they just recently redesigned the protocol to version 2; all the docs on autobahn.ws/python are
 out of date and full of broken links, and they moved all the python code to "wamp1/".
</p>

<p>And if that wasn't enough, this should be: their own list of exports is incorrect:<pre><code>
In [1]: from autobahn.wamp.websocket import *
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-6a1d1416c112> in <module>()
----> 1 from autobahn.wamp.websocket import *

AttributeError: 'module' object has no attribute 'WampServerProtocol'

</code></pre>
</p>

<p> -kousu</p>

</body>
</html>
